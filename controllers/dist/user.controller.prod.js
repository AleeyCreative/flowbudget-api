"use strict";function ownKeys(r,e){var t,n=Object.keys(r);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(r),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),n.push.apply(n,t)),n}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var phash=require("password-hash"),dbInstance=require("../database/index"),validation=require("../utilities/validation/index"),generateToken=require("../utilities/generate-token"),sanitize=require("../utilities/sanitize"),generateResetLink=require("../utilities/generate-reset-link"),emailer=require("../emailer/index"),ERRORS=require("../errors/index"),_require=require("../utilities/statuses"),AUTH_STATUS_FAIL=_require.AUTH_STATUS_FAIL,MAIL_STATUS_FAIL=_require.MAIL_STATUS_FAIL,SUCCESS=_require.SUCCESS;exports.registerUser=function(r,t){var n,a,s,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.body,validation.user(n))return a=_objectSpread({},a=sanitize(n),{password:phash.generate(a.password,{saltLength:10})}),e.next=7,regeneratorRuntime.awrap(dbInstance.registerUser(a));e.next=19;break;case 7:if(s=e.sent)return i=generateToken(s),e.next=12,regeneratorRuntime.awrap(dbInstance.fetchBudget(s._id));e.next=16;break;case 12:(o=e.sent)?t.status(SUCCESS).json({token:i,budgets:o}):t.status(AUTH_STATUS_FAIL).json(ERRORS.database_err),e.next=17;break;case 16:t.status(AUTH_STATUS_FAIL).json(ERRORS.database_err);case 17:e.next=20;break;case 19:t.status(AUTH_STATUS_FAIL).json(ERRORS.validation_err);case 20:case"end":return e.stop()}})},exports.loginUser=function(r,t){var n,a,s,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=validation.user(r.body))return a=sanitized(n),e.next=5,regeneratorRuntime.awrap(dbInstance.fetchUser(a));e.next=22;break;case 5:if(!(s=e.sent)){e.next=19;break}if(phash.verify(s.password,a.password))return i=generateToken(s),e.next=12,regeneratorRuntime.awrap(dbInstance.fetchBudget(s._id));e.next=16;break;case 12:o=e.sent,t.status(SUCCESS).json({token:i,budget:o}),e.next=17;break;case 16:t.status(AUTH_STATUS_FAIL).json(ERROR.password_err);case 17:e.next=20;break;case 19:t.status(AUTH_STATUS_FAIL).json(ERROR.database_err);case 20:e.next=23;break;case 22:t.status(AUTH_STATUS_FAIL).json(ERROR.validation_err);case 23:case"end":return e.stop()}})},exports.forgetPassword=function(r,t){var n,a,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=sanitize({email:r.params.email}),e.next=3,regeneratorRuntime.awrap(dbInstance.fetchUserWithKey(n));case 3:if(e.sent,existingUser)return e.next=7,regeneratorRuntime.awrap(generateResetLink(dbInstance,existingUser));e.next=14;break;case 7:return a=e.sent,e.next=10,regeneratorRuntime.awrap(emailer.mail(a));case 10:e.sent?(s={done:!0},t.status(SUCCESS).json(s)):t.status(MAIL_STATUS_FAIL).json(ERROR.email_err),e.next=15;break;case 14:t.status(AUTH_STATUS_FAIL).json(ERROR.database_err);case 15:case"end":return e.stop()}})},exports.resetPassword=function(r){var t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:t=r.body,t.resetLink,n=t.password,n=phash.generate(n,{saltLength:10});case 2:case"end":return e.stop()}})};